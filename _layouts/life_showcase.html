<!DOCTYPE html>
<html>
<head>
  {% include head.html %}
  <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">

  <style>
    /* ===== 背景延伸全版 ===== */
    body {
      background: url('{{ site.baseurl }}/{{ page.image }}') center center / cover no-repeat fixed;
      position: relative;
    }
    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(20,20,20,0.85);
      z-index: 0;
    }
    #banner, #main.gallery-main {
      background: none !important;
      position: relative;
      z-index: 1;
    }
    #banner {
      padding: 8em 2em;
    }
    #banner:after { background: none !important; }

    /* ===== Grid & fragments ===== */
    #main.gallery-main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 4em 2em;
    }
    #main.gallery-main > section {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      grid-gap: 6em;
      justify-items: center;
    }

    .post-fragment {
      position: relative;
      width: 220px;
      height: 220px;
      background-size: cover;
      background-position: center center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.35);
      transition: transform 0.25s ease-out, opacity 0.3s ease; /* 加入 opacity transition */
      border-radius: 6px;
      transform: translate(var(--dx, 0px), var(--dy, 0px));
      will-change: transform;
      backface-visibility: hidden;
      -webkit-transform: translateZ(0);
    }
    .post-fragment:hover {
      transform: translate(var(--dx, 0px), var(--dy, 0px)) scale(1.05);
      z-index: 2;
    }

    .post-fragment .click-area {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 3;
    }

    /* ===== Info popup（保護框） ===== */
    .info-popup {
      position: absolute;
      /* 位置校準邏輯將會透過 JS 動態調整 top/left/transform */
      top: -260px;
      left: 50%;
      transform: translateX(-50%);
      width: min(880px, 80vw);
      min-height: min(440px, 50vh);
      box-sizing: border-box;
      background: rgba(0,0,0,0.72);
      border-radius: 12px;
      padding: 1.25rem 1.5rem;
      box-shadow: 0 10px 40px rgba(0,0,0,0.6), 0 0 30px rgba(94,234,212,0.14) inset;
      font-family: 'Permanent Marker', cursive;
      color: #5eead4;
      text-align: left;
      opacity: 0;
      z-index: 9999;
      pointer-events: none;
      overflow-wrap: break-word;
      word-break: break-word;
      hyphens: auto;
      transition: opacity 0.25s ease-in-out;
    }

    /* 手機版：用 class 控制顯示狀態 */
    .post-fragment.info-visible .info-popup {
      opacity: 1;
    }
    /* 電腦版：用 hover 控制顯示狀態 */
    .post-fragment:hover .info-popup {
      opacity: 1;
    }

    /* 文字層次 */
    .info-popup .date, .info-popup .title, .info-popup .subtitle {
      white-space: normal;
      overflow-wrap: break-word;
      word-break: break-word;
    }
    .info-popup .date { font-size: 2.5rem; margin-bottom: 0.5rem; color: #93f9e6; line-height: 1.1; }
    .info-popup .title { font-size: 5rem; margin-bottom: 0.6rem; color: #5eead4; line-height: 1.15; text-shadow: 0 0 6px rgba(94,234,212,0.9), 0 0 18px rgba(94,234,212,0.35); }
    .info-popup .subtitle { font-size: 2.5rem; color: #a5ffe5; line-height: 1.3; }

    /* 打字效果 */
    .typing::after {
      content: ""; display: inline-block; width: 2px; height: 1em; background: #5eead4;
      margin-left: 6px; vertical-align: text-bottom; animation: blink 0.8s steps(2, start) infinite;
    }
    @keyframes blink { 50% { opacity: 0 } }

    /* 小螢幕調整 */
    @media (max-width: 600px) {
      .info-popup { top: -220px; width: calc(100% - 40px); min-height: 200px; padding: 1rem; }
      .info-popup .title { font-size: 1.15rem; }
      .info-popup .subtitle { font-size: 0.95rem; }
    }
  </style>
</head>

<body>
  {% include header.html %}

  <section id="banner">
    <div class="inner">
      <header class="major">
        <h1>{{ page.title }}</h1>
      </header>
      <div class="content">
        <p>{{ page.description }}</p>
      </div>
    </div>
  </section>

  <div id="main" class="gallery-main">
    <section>
      {% assign life_posts = site.posts | where: "category", "Life" | reverse %}
      {% for post in life_posts %}
        <article class="post-fragment" style="background-image: url('{{ site.baseurl }}/{{ post.image }}');">
          <a href="{{ post.url | relative_url }}" class="click-area" aria-label="{{ post.title }}"></a>
          <div class="info-popup"
               data-date="{{ post.date | date: "%Y-%m-%d" }}"
               data-title="{{ post.short_title | default: post.title }}"
               data-subtitle="{{ post.subtitle }}">
          </div>
        </article>
      {% endfor %}
    </section>
  </div>

  {% include footer.html %}

  <script>
    document.addEventListener('DOMContentLoaded', () => {

      // ===================================================================
      // 1. 核心功能函數 (打字, 顯示/隱藏資訊框) - 電腦和手機共用
      // ===================================================================
      
      /**
       * 打字效果函數，返回一個 Promise
       */
      function typeText(el, text, speed = 30) {
        return new Promise((resolve, reject) => {
          if (!el) { reject("Element not found"); return; }
          el.textContent = "";
          let i = 0;
          function step() {
            if (i < text.length) {
              el.textContent += text.charAt(i);
              i++;
              const timerId = setTimeout(step, speed);
              // 將 timerId 附加到元素上，以便可以從外部清除
              if (!el._timers) el._timers = [];
              el._timers.push(timerId);
            } else {
              resolve();
            }
          }
          step();
        });
      }

      /**
       * 清除指定元素上所有正在運行的打字計時器
       */
      function clearTypingTimers(el) {
        if (el && el._timers) {
          el._timers.forEach(clearTimeout);
          el._timers = [];
        }
      }

      /**
       * 顯示資訊框並觸發打字效果
       * @param {HTMLElement} fragment - The .post-fragment element
       */
      function showInfoPopup(fragment) {
        const popup = fragment.querySelector('.info-popup');
        if (!popup) return;

        // 清空舊內容並添加打字光標
        popup.innerHTML = `
          <div class="date typing"></div>
          <div class="title typing"></div>
          <div class="subtitle typing"></div>
        `;
        const dateEl = popup.querySelector('.date');
        const titleEl = popup.querySelector('.title');
        const subtitleEl = popup.querySelector('.subtitle');

        const date = popup.dataset.date || "";
        const title = popup.dataset.title || "";
        const subtitle = popup.dataset.subtitle || "";

        // ** 邊界檢測與位置校準 **
        calibratePopupPosition(fragment, popup);

        // 鏈式 Promise 執行打字
        typeText(dateEl, date, 25)
          .then(() => { dateEl.classList.remove('typing'); return typeText(titleEl, title, 18); })
          .then(() => { titleEl.classList.remove('typing'); return typeText(subtitleEl, subtitle, 18); })
          .then(() => { subtitleEl.classList.remove('typing'); })
          .catch(console.error);
      }

      /**
       * 隱藏資訊框並停止打字
       * @param {HTMLElement} fragment - The .post-fragment element
       */
      function hideInfoPopup(fragment) {
        const popup = fragment.querySelector('.info-popup');
        if (!popup) return;
        
        popup.querySelectorAll('.typing').forEach(el => clearTypingTimers(el));
        popup.innerHTML = "";
        popup.removeAttribute('style'); // 清除所有臨時位置樣式
      }

      /**
       * 邊界檢測，智能調整彈出框位置
       * (*** 考慮 Header 版本 ***)
       */
      function calibratePopupPosition(fragment, popup) {
          // 確保 popup 是可見的以便測量尺寸，但不顯示出來
          popup.style.visibility = 'hidden';
          popup.style.display = 'block';
          const popupRect = popup.getBoundingClientRect();
          popup.style.visibility = '';
          popup.style.display = '';

          const fragmentRect = fragment.getBoundingClientRect();
          const viewportWidth = window.innerWidth;
          
          // --- 新增：動態計算頂部安全邊界 ---
          const header = document.querySelector('#header'); // 假設你的 header 標籤 ID 是 'header'
          let topBoundary = 10; // 預設 10px 邊距
          if (header) {
            // 如果搵到 header，安全邊界就係 header 嘅高度 + 10px
            topBoundary = header.offsetHeight + 10;
          }
          
          // --- 核心邏輯：使用新嘅 topBoundary ---
          let top = -260; // 預設的相對 top 值

          const potentialPopupTopY = fragmentRect.top + top;
          
          // 如果潛在位置高過咗我哋嘅安全邊界
          if (potentialPopupTopY < topBoundary) {
            // 直接計算出一個新嘅 top 值，令資訊框頂部剛剛好喺安全邊界上
            top = topBoundary - fragmentRect.top;
          }

          // --- 水平位置檢查 (維持不變) ---
          let left = '50%';
          let transform = 'translateX(-50%)';
          let right = 'auto';

          const fragmentCenter = fragmentRect.left + fragmentRect.width / 2;
          if (fragmentCenter - (popupRect.width / 2) < 10) {
              left = '10px';
              transform = 'translateX(0)';
          } else if (fragmentCenter + (popupRect.width / 2) > (viewportWidth - 10)) {
              left = 'auto';
              right = '10px';
              transform = 'translateX(0)';
          }

          // 應用計算後的所有樣式
          popup.style.top = `${top}px`;
          popup.style.left = left;
          popup.style.right = right;
          popup.style.transform = transform;
      }

      // ===================================================================
      // 2. 設備偵測與邏輯分流
      // ===================================================================

      const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      const allFragments = document.querySelectorAll('.post-fragment');

      if (!isTouchDevice) {
        // --- 電腦版邏輯：滑鼠懸浮 ---
        allFragments.forEach(fragment => {
          // 初始隨機偏移
          const dx = (Math.random() - 0.5) * 80;
          const dy = (Math.random() - 0.5) * 60;
          fragment.style.setProperty('--dx', `${dx}px`);
          fragment.style.setProperty('--dy', `${dy}px`);

          fragment.addEventListener('mouseenter', () => {
            showInfoPopup(fragment);
          });
          fragment.addEventListener('mouseleave', () => {
            hideInfoPopup(fragment);
          });
        });
      } else {
        // --- 手機版邏輯：點擊觸發 ---
        allFragments.forEach(fragment => {
          // 初始隨機偏移
          const dx = (Math.random() - 0.5) * 20; // 手機上偏移量可以小一些
          const dy = (Math.random() - 0.5) * 20;
          fragment.style.setProperty('--dx', `${dx}px`);
          fragment.style.setProperty('--dy', `${dy}px`);

          const clickArea = fragment.querySelector('.click-area');
          clickArea.addEventListener('click', (event) => {
            const isVisible = fragment.classList.contains('info-visible');

            if (isVisible) {
              // 如果資訊框已顯示，則第二次點擊是導航，不阻止預設行為
              return;
            }

            // 首次點擊，阻止導航
            event.preventDefault();

            // 關閉所有其他已打開的資訊框
            allFragments.forEach(otherFragment => {
              if (otherFragment !== fragment && otherFragment.classList.contains('info-visible')) {
                otherFragment.classList.remove('info-visible');
                hideInfoPopup(otherFragment);
              }
            });

            // 顯示當前點擊的資訊框
            showInfoPopup(fragment);
            fragment.classList.add('info-visible');
          });
        });

        // 全局監聽：點擊空白處關閉資訊框
        document.addEventListener('click', (event) => {
          // 如果點擊的目標不是 fragment 或其子元素，則關閉所有打開的資訊框
          if (!event.target.closest('.post-fragment')) {
            allFragments.forEach(fragment => {
              if (fragment.classList.contains('info-visible')) {
                fragment.classList.remove('info-visible');
                hideInfoPopup(fragment);
              }
            });
          }
        });
      }
    });
  </script>
</body>
</html>
